<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡ç±Œç¢¼çµæ®º - é¦¬å¹´æˆ°ç•¥ç‰ˆ</title>
    <style>
        :root { --primary: #c2410c; --bg: #fff7ed; --card: #ffffff; --text: #431407; --red: #dc2626; --green: #16a34a; --input-bg: #ffedd5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); padding-bottom: 100px; }
        .container { max-width: 500px; margin: 0 auto; background: var(--card); border-radius: 20px; box-shadow: 0 10px 25px rgba(194, 65, 12, 0.15); overflow: hidden; }
        
        /* åœ–ç‰‡ */
        .hero-img { width: 100%; height: 160px; object-fit: cover; display: block; }
        .content-pad { padding: 20px; }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 24px; margin: 0; color: #9a3412; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { font-size: 13px; color: #ea580c; margin-top: 4px; font-weight: 500; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; font-size: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-auto { background: linear-gradient(135deg, #ea580c, #c2410c); color: white; }
        .btn-auto:active { transform: scale(0.98); }
        .btn-clear { background: #f1f5f9; color: #64748b; max-width: 100px; }
        
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .section-title { font-size: 14px; font-weight: 700; color: #9a3412; border-left: 4px solid #ea580c; padding-left: 8px; margin: 25px 0 10px 0; }

        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-group { flex: 1; position: relative; }
        label { display: block; font-size: 12px; color: #7c2d12; margin-bottom: 4px; font-weight: 600; }
        
        input { width: 100%; padding: 12px; border: 2px solid transparent; border-radius: 12px; font-size: 18px; font-weight: 700; box-sizing: border-box; background: var(--input-bg); color: #431407; outline: none; transition: 0.2s; -webkit-appearance: none; text-align: center; }
        input:focus { background: #fff; border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2); }
        input::placeholder { color: #fdba74; font-size: 14px; }

        .tx-input input { background: #fff7ed; border: 2px solid #ea580c; color: #c2410c; }
        .long-input input { color: var(--red); background: #fef2f2; }
        .short-input input { color: var(--green); background: #f0fdf4; }

        /* åƒ¹å·®é¡¯ç¤ºæ¢ */
        .spread-bar { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #fed7aa; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; font-weight: 600; }
        .spread-val { font-weight: 800; font-size: 15px; }

        /* ç¸½çµå»ºè­°å¡ç‰‡ */
        .advice-card { background: #431407; color: white; padding: 15px; border-radius: 12px; margin-top: 20px; box-shadow: 0 4px 15px rgba(67, 20, 7, 0.2); }
        .advice-header { font-size: 12px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .advice-content { font-size: 16px; font-weight: 700; line-height: 1.4; }
        .advice-trend { font-size: 24px; font-weight: 900; margin-bottom: 5px; display: block; }

        /* ç­–ç•¥è¡¨æ ¼ */
        .strategy-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #ffedd5; }
        .strategy-table th { background: #ea580c; color: white; padding: 10px; font-size: 13px; }
        .strategy-table td { padding: 12px; text-align: center; border-bottom: 1px solid #fed7aa; font-weight: bold; font-size: 15px; }
        
        .row-200 { background: rgba(255, 255, 255, 1); }
        .row-300 { background: #fff7ed; }
        .row-400 { background: #ffedd5; }
        .row-500 { background: #fed7aa; }

        #status-msg { text-align: center; font-size: 12px; margin-bottom: 10px; min-height: 18px; font-weight: 500; color: #ea580c; }
    </style>
</head>
<body>

<div class="container">
    <img src="https://images.unsplash.com/photo-1598974357801-cbca100e65d3?q=80&w=1000&auto=format&fit=crop" class="hero-img" alt="é¦¬åˆ°æˆåŠŸ">

    <div class="content-pad">
        <header>
            <h1>ğŸ å°æŒ‡ç±Œç¢¼ - æˆ°ç•¥ç¸½çµç‰ˆ</h1>
            <div class="subtitle">åƒ¹å·®åˆ†æ â€¢ æ™ºèƒ½å»ºè­° â€¢ é»ä½æ¨æ¼”</div>
        </header>

        <div class="btn-group">
            <button class="action-btn btn-auto" onclick="autoDetect()" id="autoBtn">
                <span id="btn-icon">âš¡</span> æŠ“å– åŠ æ¬Š & æ³¢å‹•
            </button>
            <button class="action-btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
        <div id="status-msg"></div>

        <div class="section-title">ğŸ“ é»ä½èˆ‡åƒ¹å·®</div>
        <div class="input-row">
            <div class="input-group">
                <label>åŠ æ¬ŠæŒ‡æ•¸ (ç¾è²¨)</label>
                <input type="number" id="spot_price" placeholder="è‡ªå‹•" disabled style="opacity:0.7">
            </div>
            <div class="input-group">
                <label>æ³¢å‹•ç‡ (ATR)</label>
                <input type="number" id="volatility" placeholder="è‡ªå‹•" oninput="saveAndCalc()">
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-group tx-input">
                <label>â­ å°æŒ‡æœŸ (æ‰‹å‹•è¼¸å…¥)</label>
                <input type="number" id="tx_price" placeholder="è¼¸å…¥ç›®å‰é»æ•¸" oninput="saveAndCalc()">
            </div>
        </div>

        <div class="spread-bar">
            <span style="color:#7c2d12">åŸºå·® (æœŸ - ç¾)</span>
            <span id="spread-val" class="spread-val" style="color:#9ca3af;">--</span>
        </div>

        <div class="section-title">ğŸ‘¥ æ•£æˆ¶ç±Œç¢¼ (æ‰‹å‹•è¼¸å…¥)</div>
        <div class="input-row">
            <div class="input-group long-input">
                <label>å°å°å¤šå–®</label>
                <input type="number" id="mtx_long" placeholder="0" oninput="saveAndCalc()">
            </div>
            <div class="input-group short-input">
                <label>å°å°ç©ºå–®</label>
                <input type="number" id="mtx_short" placeholder="0" oninput="saveAndCalc()">
            </div>
        </div>
        <div class="input-row">
            <div class="input-group long-input">
                <label>å¾®å°å¤šå–®</label>
                <input type="number" id="tmf_long" placeholder="0" oninput="saveAndCalc()">
            </div>
            <div class="input-group short-input">
                <label>å¾®å°ç©ºå–®</label>
                <input type="number" id="tmf_short" placeholder="0" oninput="saveAndCalc()">
            </div>
        </div>

        <div class="advice-card">
            <div class="advice-header">AI ç±Œç¢¼ç¸½çµå»ºè­°</div>
            <span id="advice-trend" class="advice-trend">ç­‰å¾…æ•¸æ“š...</span>
            <div id="advice-content" class="advice-content">è«‹è¼¸å…¥å°æŒ‡æœŸé»æ•¸èˆ‡æ•£æˆ¶ç±Œç¢¼ä»¥é€²è¡Œåˆ†æã€‚</div>
        </div>

        <div class="section-title">ğŸ“Š ä¸»åŠ›ç›®æ¨™åƒ¹æ¨æ¼” (æ³¢å‹•åŠ‡æœ¬)</div>
        <div id="table-container">
            <table class="strategy-table">
                <thead>
                    <tr>
                        <th>æ³¢å‹• ATR</th>
                        <th>é ä¼°ç›®æ¨™ (æœŸ)</th>
                        <th>ä¸»åŠ›å‹•å‘</th>
                    </tr>
                </thead>
                <tbody id="scenario-body">
                    <tr><td colspan="3" style="color:#9ca3af; padding:20px;">ç­‰å¾…è¨ˆç®—...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const fields = ['spot_price', 'volatility', 'tx_price', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    window.onload = function() {
        fields.forEach(id => {
            const savedVal = localStorage.getItem(id);
            if (savedVal) document.getElementById(id).value = savedVal;
        });
        calculate();
    }

    // åªæŠ“ åŠ æ¬ŠæŒ‡æ•¸ å’Œ ATR
    async function autoDetect() {
        const btn = document.getElementById('autoBtn');
        const icon = document.getElementById('btn-icon');
        const status = document.getElementById('status-msg');
        
        btn.disabled = true;
        icon.classList.add('loading-spin');
        status.innerText = "é€£ç·š Yahoo Finance ä¸­...";
        
        try {
            const symbol = "%5ETWII"; 
            const timestamp = new Date().getTime();
            // æŠ“å– 5 å¤©è³‡æ–™ç®— ATR
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/' + symbol + '?interval=1d&range=5d&_=' + timestamp)}`;
            
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const result = JSON.parse(data.contents).chart.result[0];
            const quotes = result.indicators.quote[0];
            const lastClose = result.meta.regularMarketPrice;
            
            // è¨ˆç®— ATR
            let totalRange = 0;
            let count = 0;
            const len = quotes.high.length;
            for (let i = 0; i < len; i++) {
                if (quotes.high[i] && quotes.low[i]) {
                    totalRange += (quotes.high[i] - quotes.low[i]);
                    count++;
                }
            }
            const avgVol = count > 0 ? Math.round(totalRange / count) : 300;

            // å¡«å…¥æ•¸å€¼ (åªå¡«ç¾è²¨å’Œæ³¢å‹•ï¼Œä¸ç¢°æœŸè²¨æ¬„ä½)
            document.getElementById('spot_price').value = Math.round(lastClose);
            document.getElementById('volatility').value = avgVol;

            saveAndCalc();
            status.innerText = `âœ… æ›´æ–°å®Œç•¢ï¼åŠ æ¬Š ${Math.round(lastClose)} | æ³¢å‹• ${avgVol}`;
            status.style.color = "#16a34a";
            
        } catch (error) {
            console.error(error);
            status.innerText = "âš ï¸ æŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
            status.style.color = "#dc2626";
        } finally {
            btn.disabled = false;
            icon.classList.remove('loading-spin');
        }
    }

    function saveAndCalc() {
        fields.forEach(id => {
            const el = document.getElementById(id);
            if(el) localStorage.setItem(id, el.value);
        });
        calculate();
    }

    function clearAll() {
        if(confirm('æ¸…é™¤æ‰€æœ‰æ•¸æ“šï¼Ÿ')) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
                localStorage.removeItem(id);
            });
            calculate();
        }
    }

    function calculate() {
        let spot = parseInt(document.getElementById('spot_price').value) || 0;
        let tx = parseInt(document.getElementById('tx_price').value) || 0;
        let vol = parseInt(document.getElementById('volatility').value) || 300;
        
        // ç±Œç¢¼è¨ˆç®—
        let mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        let mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        let tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        let tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        let total_net = (mtx_L - mtx_S) + (tmf_L - tmf_S) * 0.2;
        
        // 1. è¨ˆç®—åƒ¹å·®
        const spreadEl = document.getElementById('spread-val');
        let spread = 0;
        if (tx !== 0 && spot !== 0) {
            spread = tx - spot;
            if (spread > 0) {
                spreadEl.innerText = `â–² æ­£åƒ¹å·® +${spread}`;
                spreadEl.style.color = "#dc2626";
            } else if (spread < 0) {
                spreadEl.innerText = `â–¼ é€†åƒ¹å·® ${spread}`;
                spreadEl.style.color = "#16a34a";
            } else {
                spreadEl.innerText = "å¹³åƒ¹å·® 0";
                spreadEl.style.color = "#4b5563";
            }
        } else {
            spreadEl.innerText = "--";
            spreadEl.style.color = "#9ca3af";
        }

        // 2. ç”Ÿæˆå»ºè­°èˆ‡è¶¨å‹¢
        const trendEl = document.getElementById('advice-trend');
        const contentEl = document.getElementById('advice-content');
        const card = document.querySelector('.advice-card');
        
        let direction = 0; // 0:ç›¤æ•´, 1:æ®ºå¤š(è·Œ), -1:è»‹ç©º(æ¼²)
        const THRESHOLD = 1500;

        if (tx === 0) {
            trendEl.innerText = "ç­‰å¾…è¼¸å…¥...";
            contentEl.innerText = "è«‹è¼¸å…¥ã€Œå°æŒ‡æœŸã€é»æ•¸ä»¥é€²è¡Œåˆ†æã€‚";
            card.style.background = "#4b5563";
            renderTable(0, 0);
            return;
        }

        if (total_net > THRESHOLD) {
            // æ•£æˆ¶å¤§èˆ‰åšå¤š -> ä¸»åŠ›å¯èƒ½æ®ºç›¤
            direction = 1; 
            trendEl.innerText = "ğŸ“‰ ç±Œç¢¼åç©º (ä¸»åŠ›æ®ºå¤š)";
            card.style.background = "#166534"; // ç¶ åº•

            if (spread < -30) {
                contentEl.innerText = "âš ï¸ å±éšªï¼æ•£æˆ¶åšå¤šä¸”é€†åƒ¹å·®æ“´å¤§ï¼Œä¸»åŠ›æœ‰å£“ä½å‡ºè²¨å«Œç–‘ï¼Œæ…é˜²æ€¥æ®ºç ´åº•ã€‚";
            } else if (spread > 30) {
                contentEl.innerText = "âš ï¸ æ•£æˆ¶è¿½é«˜æ­£åƒ¹å·®ï¼Œä¸»åŠ›å¯èƒ½åˆ©ç”¨æ­£åƒ¹å·®é€²è¡Œæ®ºç›¤æ”¶æ–‚ï¼Œå¤šå–®å®œæ¸›ç¢¼ã€‚";
            } else {
                contentEl.innerText = "æ•£æˆ¶ç±Œç¢¼åå¤šï¼Œä¸»åŠ›ä¸Šæ–¹å£“åŠ›å¤§ï¼Œå»ºè­°æ‰¾åå½ˆç©ºé»ï¼Œç›®æ¨™çœ‹ä¸‹æ–¹æ”¯æ’ã€‚";
            }

        } else if (total_net < -THRESHOLD) {
            // æ•£æˆ¶å¤§èˆ‰åšç©º -> ä¸»åŠ›å¯èƒ½è»‹ç©º
            direction = -1;
            trendEl.innerText = "ğŸš€ ç±Œç¢¼åå¤š (ä¸»åŠ›è»‹ç©º)";
            card.style.background = "#991b1b"; // ç´…åº•

            if (spread > 30) {
                contentEl.innerText = "ğŸ”¥ å¼·å‹¢ï¼æ•£æˆ¶åšç©ºä¸”æ­£åƒ¹å·®æ“´å¤§ï¼Œä¸»åŠ›å¼·å‹¢è»‹ç©ºï¼Œåˆ‡å‹¿éš¨æ„æ‘¸é ­çŒœé ‚ã€‚";
            } else if (spread < -30) {
                contentEl.innerText = "ğŸ”¥ æ•£æˆ¶è¿½ç©ºé€†åƒ¹å·®ï¼Œä¸»åŠ›å¯èƒ½åˆ©ç”¨é€†åƒ¹å·®å¼·å‹¢æ‹‰æŠ¬æ”¶æ–‚ï¼Œç©ºå–®å‹™å¿…è¨­åœæã€‚";
            } else {
                contentEl.innerText = "æ•£æˆ¶ç±Œç¢¼åç©ºï¼Œä¸»åŠ›ä¸‹æ–¹æ”¯æ’å¼·ï¼Œå»ºè­°æ‹‰å›æ‰¾è²·é»ï¼Œç›®æ¨™çœ‹ä¸Šæ–¹å£“åŠ›ã€‚";
            }

        } else {
            // ç›¤æ•´
            direction = 0;
            trendEl.innerText = "âš–ï¸ ç±Œç¢¼ä¸­æ€§ (å€é–“éœ‡ç›ª)";
            card.style.background = "#4b5563"; // ç°åº•
            contentEl.innerText = "ç›®å‰å¤šç©ºåŠ›é“å‡è¡¡ï¼Œå»ºè­°è§€æœ›æˆ–åœ¨å€é–“é‚Šç·£æ“ä½œï¼Œç­‰å¾…æ–¹å‘æ˜ç¢ºã€‚";
        }

        // 3. ç”¢ç”Ÿæ³¢å‹•åŠ‡æœ¬è¡¨æ ¼
        renderTable(tx, direction);
    }

    function renderTable(price, direction) {
        const tbody = document.getElementById('scenario-body');
        tbody.innerHTML = "";

        if (price === 0 || direction === 0) {
             tbody.innerHTML = `<tr><td colspan="3" style="color:#9ca3af; padding:20px;">ç„¡æ˜é¡¯è¶¨å‹¢æˆ–ç¼ºæ•¸æ“š</td></tr>`;
             return;
        }

        const atrs = [200, 300, 400, 500];
        
        atrs.forEach(atr => {
            let target = 0;
            let actionText = "";
            let colorClass = "";
            let rowClass = `row-${atr}`;

            if (direction === 1) { // æ®ºç›¤
                target = price - atr;
                actionText = `æ®º ${atr} é»`;
                colorClass = "color: #16a34a;";
            } else { // è»‹ç©º
                target = price + atr;
                actionText = `æ‹‰ ${atr} é»`;
                colorClass = "color: #dc2626;";
            }

            tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td style="color:#7c2d12;">ATR ${atr}</td>
                    <td style="font-size:18px; ${colorClass}">${target}</td>
                    <td style="font-size:13px; ${colorClass}">${actionText}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>
