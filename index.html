<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡ç±Œç¢¼çµæ®º - TVæˆ°æƒ…ç‰ˆ</title>
    <style>
        :root { --primary: #172d7a; --bg: #f0f3fa; --card: #ffffff; --text: #131722; --red: #f23645; --green: #089981; --input-bg: #f1f3f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: var(--text); padding-bottom: 220px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* TradingView å®¹å™¨ */
        .tv-container { height: 400px; width: 100%; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { padding: 20px; }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 20px; margin: 0; color: #131722; font-weight: 800; }
        .subtitle { font-size: 12px; color: #787b86; margin-top: 4px; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-auto { background: #2962ff; color: white; }
        .btn-auto:active { background: #1e53e5; transform: scale(0.98); }
        .btn-clear { background: #e0e3eb; color: #131722; max-width: 100px; }
        
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .section-title { font-size: 12px; font-weight: 700; color: #787b86; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 8px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #e0e3eb; }

        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-group { flex: 1; position: relative; }
        label { display: block; font-size: 11px; color: #787b86; margin-bottom: 4px; font-weight: 500; }
        
        input { width: 100%; padding: 12px; border: 1px solid #e0e3eb; border-radius: 8px; font-size: 16px; font-weight: 600; box-sizing: border-box; background: var(--input-bg); color: #131722; outline: none; transition: 0.2s; -webkit-appearance: none; }
        input:focus { background: #fff; border-color: #2962ff; }

        .tx-input input { border: 2px solid #bfdbfe; background: #eff6ff; color: #1e3a8a; }
        .long-input input { color: var(--red); background: #fff2f2; border-color: #ffcfcf; }
        .short-input input { color: var(--green); background: #e6fcf5; border-color: #b2f2bb; }

        /* çµæœå¡ç‰‡ */
        #result-card { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 580px; 
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 16px; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); 
            border: 1px solid #e0e3eb;
            z-index: 100;
            overflow: hidden;
            transition: 0.3s;
        }
        .result-header { padding: 10px 15px; text-align: center; color: white; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
        .bg-red { background: #f23645; } 
        .bg-green { background: #089981; } 
        .bg-gray { background: #787b86; }
        .result-content { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
        .main-stat { text-align: left; }
        .stat-value { font-size: 22px; font-weight: 800; font-family: monospace; }
        .target-box { text-align: right; }
        .target-price { font-size: 20px; font-weight: 800; }
        .target-desc { font-size: 12px; opacity: 0.8; }
        #status-msg { text-align: center; font-size: 12px; margin-bottom: 10px; min-height: 18px; font-weight: 500; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="tv-container">
        <div class="tradingview-widget-container" style="height:100%;width:100%">
            <div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
            {
            "autosize": true,
            "symbol": "TWSE:TAIEX",
            "interval": "D",
            "timezone": "Asia/Taipei",
            "theme": "light",
            "style": "1",
            "locale": "zh-TW",
            "enable_publishing": false,
            "hide_top_toolbar": true,
            "hide_legend": false,
            "save_image": false,
            "calendar": false,
            "hide_volume": true,
            "support_host": "https://www.tradingview.com",
            "studies": [
                "MASimple@tv-basicstudies",
                "MASimple@tv-basicstudies",
                "BB@tv-basicstudies"
            ],
            "studies_overrides": {
                "MASimple@tv-basicstudies.length": 60,
                "MASimple@tv-basicstudies.plottype": "line",
                "MASimple@tv-basicstudies.color": "#2962FF",
                
                "MASimple@tv-basicstudies.length_1": 200,
                "MASimple@tv-basicstudies.plottype_1": "line",
                "MASimple@tv-basicstudies.color": "#FF9800"
            }
            }
            </script>
        </div>
    </div>

    <div class="control-panel">
        <header>
            <h1>ğŸ“‰ å°æŒ‡ç±Œç¢¼çµæ®º <span style="font-size:12px; background:#e0e3eb; color:#131722; padding:3px 8px; border-radius:20px;">TVç‰ˆ</span></h1>
            <div class="subtitle">ä¸Šæ–¹åœ–è¡¨åƒ…ä¾›è¶¨å‹¢åƒè€ƒï¼Œä¸‹æ–¹è¨ˆç®—é»ä½</div>
        </header>

        <div class="btn-group">
            <button class="action-btn btn-auto" onclick="autoDetect()" id="autoBtn">
                <span id="btn-icon">âš¡</span> å¿«é€ŸæŠ“å–ç›®å‰é»æ•¸
            </button>
            <button class="action-btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
        <div id="status-msg"></div>

        <div class="section-title">ğŸ“Š åƒ¹æ ¼åƒæ•¸</div>
        <div class="input-row">
            <div class="input-group">
                <label>åŠ æ¬ŠæŒ‡æ•¸</label>
                <input type="number" id="spot_price" placeholder="è‡ªå‹•" disabled style="background:#f1f3f6;">
            </div>
            <div class="input-group">
                <label>æ³¢å‹•ç‡ (ATR)</label>
                <input type="number" id="volatility" placeholder="300" oninput="saveAndCalc()">
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-group tx-input">
                <label>ğŸ“ å°æŒ‡æœŸ (ç›®æ¨™è¨ˆç®—åŸºæº–)</label>
                <input type="number" id="tx_price" placeholder="è¼¸å…¥æœŸè²¨é»æ•¸" oninput="saveAndCalc()">
            </div>
        </div>

        <div class="section-title">ğŸ“‰ æ•£æˆ¶ç±Œç¢¼ (å°å°/å¾®å°)</div>
        <div class="input-row">
            <div class="input-group long-input">
                <label>MTX å¤šå–®</label>
                <input type="number" id="mtx_long" placeholder="0" oninput="saveAndCalc()">
            </div>
            <div class="input-group short-input">
                <label>MTX ç©ºå–®</label>
                <input type="number" id="mtx_short" placeholder="0" oninput="saveAndCalc()">
            </div>
        </div>
        <div class="input-row">
            <div class="input-group long-input">
                <label>TMF å¤šå–®</label>
                <input type="number" id="tmf_long" placeholder="0" oninput="saveAndCalc()">
            </div>
            <div class="input-group short-input">
                <label>TMF ç©ºå–®</label>
                <input type="number" id="tmf_short" placeholder="0" oninput="saveAndCalc()">
            </div>
        </div>
    </div>
</div>

<div id="result-card">
    <div id="res-header" class="result-header">
        <span id="header-title">ç­‰å¾…æ•¸æ“š...</span>
        <span style="font-size:11px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">å³æ™‚</span>
    </div>
    <div class="result-content">
        <div class="main-stat">
            <div style="font-size:11px; color:#787b86">æ•£æˆ¶æ·¨å–®</div>
            <div class="stat-value" id="res-total">0</div>
        </div>
        <div class="target-box">
            <div style="font-size:11px; color:#787b86" id="target-label">ç›®æ¨™åƒ¹</div>
            <div class="target-price" id="res-price">--</div>
            <div class="target-desc" id="res-action">è§€æœ›</div>
        </div>
    </div>
</div>

<script>
    const fields = ['spot_price', 'volatility', 'tx_price', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    window.onload = function() {
        fields.forEach(id => {
            const savedVal = localStorage.getItem(id);
            if (savedVal) document.getElementById(id).value = savedVal;
        });
        calculate();
    }

    // é€™è£¡æˆ‘å€‘é‚„æ˜¯å¿…é ˆç”¨ Yahoo API ä¾†æŠ“ã€Œæ•¸å€¼ã€å¡«å…¥æ¡†æ¡†ï¼Œä½†åœ–è¡¨å·²ç¶“ä¸ç”¨ Yahoo äº†
    // é€™æ¨£å°±ç®—æŠ“ä¸åˆ°æ•¸å€¼ï¼Œåœ–è¡¨è‡³å°‘é‚„æ˜¯æœƒé¡¯ç¤ºï¼Œä¸æœƒæ•´é å£æ‰
    async function autoDetect() {
        const btn = document.getElementById('autoBtn');
        const icon = document.getElementById('btn-icon');
        const status = document.getElementById('status-msg');
        
        btn.disabled = true;
        icon.classList.add('loading-spin');
        status.innerText = "æ­£åœ¨å–å¾—æœ€æ–°å ±åƒ¹...";
        
        try {
            const symbol = "%5ETWII"; 
            const timestamp = new Date().getTime();
            // åªæŠ“ 5 å¤©çš„è³‡æ–™å°±å¥½ï¼Œé€Ÿåº¦æ¯”è¼ƒå¿«
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/' + symbol + '?interval=1d&range=5d&_=' + timestamp)}`;
            
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const yahooData = JSON.parse(data.contents);
            if (!yahooData.chart || !yahooData.chart.result) throw new Error("No Data");
            
            const result = yahooData.chart.result[0];
            const quotes = result.indicators.quote[0];
            const lastClose = result.meta.regularMarketPrice;

            // ç°¡å–®è¨ˆç®— ATR (æ³¢å‹•)
            let totalRange = 0;
            let count = 0;
            const len = quotes.high.length;
            for (let i = 0; i < len; i++) {
                if (quotes.high[i] && quotes.low[i]) {
                    totalRange += (quotes.high[i] - quotes.low[i]);
                    count++;
                }
            }
            const avgVol = count > 0 ? Math.round(totalRange / count) : 300;
            
            // å¡«å…¥ UI
            document.getElementById('spot_price').value = Math.round(lastClose);
            document.getElementById('volatility').value = avgVol;
            
            if(!document.getElementById('tx_price').value) {
                document.getElementById('tx_price').value = Math.round(lastClose);
            }

            saveAndCalc();
            status.innerText = `âœ… å ±åƒ¹æ›´æ–°å®Œæˆ`;
            status.style.color = "#089981";
            
        } catch (error) {
            console.error(error);
            status.innerText = "âš ï¸ æ•¸å€¼æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥";
            status.style.color = "#f23645";
        } finally {
            btn.disabled = false;
            icon.classList.remove('loading-spin');
        }
    }

    function saveAndCalc() {
        fields.forEach(id => {
            const el = document.getElementById(id);
            if(el) localStorage.setItem(id, el.value);
        });
        calculate();
    }

    function clearAll() {
        if(confirm('æ¸…é™¤æ•¸æ“šï¼Ÿ')) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
                localStorage.removeItem(id);
            });
            calculate();
        }
    }

    function calculate() {
        let spot = parseInt(document.getElementById('spot_price').value) || 0;
        let tx = parseInt(document.getElementById('tx_price').value);
        let vol = parseInt(document.getElementById('volatility').value) || 300;
        let calcPrice = tx ? tx : spot;
        
        let mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        let mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        let tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        let tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        let mtx_net = mtx_L - mtx_S;
        let tmf_net_eq = (tmf_L - tmf_S) * 0.2; 
        let total_net = mtx_net + tmf_net_eq;
        
        const totalEl = document.getElementById('res-total');
        totalEl.innerText = total_net.toLocaleString('en-US', {maximumFractionDigits: 1});
        
        if (total_net > 0) totalEl.style.color = '#f23645'; 
        else if (total_net < 0) totalEl.style.color = '#089981'; 
        else totalEl.style.color = '#131722';
        
        let cardHeader = document.getElementById('res-header');
        let headerTitle = document.getElementById('header-title');
        let resPrice = document.getElementById('res-price');
        let resAction = document.getElementById('res-action');
        const THRESHOLD = 1500;
        
        if (total_net > THRESHOLD) {
            cardHeader.className = "result-header bg-green"; 
            headerTitle.innerText = "ğŸ“‰ æ•£æˆ¶åšå¤š âœ ä¸»åŠ›æ®ºç›¤";
            let target = calcPrice - vol;
            resPrice.innerText = target;
            resPrice.style.color = "#089981"; 
            resAction.innerText = `æ®º ${vol} é»é€¼åœæ`;
            resAction.style.color = "#e6fcf5";
        } else if (total_net < -THRESHOLD) {
            cardHeader.className = "result-header bg-red"; 
            headerTitle.innerText = "ğŸ“ˆ æ•£æˆ¶åšç©º âœ ä¸»åŠ›è»‹ç©º";
            let target = calcPrice + vol;
            resPrice.innerText = target;
            resPrice.style.color = "#f23645"; 
            resAction.innerText = `æ‹‰ ${vol} é»é€¼åœæ`;
            resAction.style.color = "#fff2f2";
        } else {
            cardHeader.className = "result-header bg-gray";
            headerTitle.innerText = "âš–ï¸ å€é–“éœ‡ç›ª";
            resPrice.innerText = "è§€æœ›";
            resPrice.style.color = "white";
            resAction.innerText = "ç„¡çµæ®ºç›®æ¨™";
            resAction.style.color = "#e0e3eb";
        }
    }
</script>
</body>
</html>
